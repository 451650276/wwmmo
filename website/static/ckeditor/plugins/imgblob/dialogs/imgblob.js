(function(){function p(a){function e(e,b){return e.replace("\x3ds100","\x3ds"+b)}function f(a,b){var c=b.getContentElement("info","filename");c.setValue("Starting...");CKEDITOR.ajax.load("/blob/upload-url",function(f){var h=JSON.parse(f).upload_url;console.log("Uploading to: "+h);var m=new XMLHttpRequest;m.upload.addEventListener("progress",function(e){b.lengthComputable&&(b=Math.round(100*b.loaded/b.total))&&c.setValue(a.name+" ... "+b+"%")},!1);m.onreadystatechange=function(){if(4==m.readyState){f=
JSON.parse(m.responseText);var a=b,c=f,k=a.getContentElement("info","filename");k.setValue(c.filename+" ("+c.width+"x"+c.height+")");k.getElement().data("resp",n.encode(JSON.stringify(c)));var h=CKEDITOR.document.getById(g),k=c.width>c.height?h.getParent().getSize("width"):h.getParent().getSize("height");h.setAttribute("src",e(c.url,k));(h=c.width>c.height?a.imageElement.getAttribute("width"):a.imageElement.getAttribute("height"))||(h=400);a.getContentElement("info","size").setValue(h);h=a.getContentElement("info",
"lightbox");a.linkElement?h.setValue(!0):h.setValue(!1);a.imageElement.setAttribute("src",e(c.url,k));a.imageElement.setAttribute("data-blobinfo",n.encode(JSON.stringify(c)))}};m.open("POST",h,!0);m.setRequestHeader("X-File-Name",a.name);m.setRequestHeader("X-File-Type",a.type);h=new FormData;h.append("file",a);m.send(h)})}var g=CKEDITOR.tools.getNextId()+"_previewImage";return{title:"Image Properties",minWidth:420,minHeight:360,onShow:function(){this.linkEditMode=this.imageEditMode=this.linkElement=
this.imageElement=!1;this.firstLoad=!0;this.addLink=!1;var a=this.getParentEditor(),b=a.getSelection(),c=(b=b&&b.getSelectedElement())&&a.elementPath(b).contains("a",1);if(c){this.linkElement=c;this.linkEditMode=!0;var e=c.getChildren();1==e.count()&&"img"==e.getItem(0).getName()&&(this.imageElement=e.getItem(0),this.imageEditMode=!0);this.setupContent(1,c)}b&&"img"==b.getName()&&!b.data("cke-realelement")&&(this.imageEditMode=!0,this.imageElement=b);this.imageEditMode?(this.originalImageElement=
this.imageElement,this.imageElement=this.originalImageElement.clone(!0,!0),this.setupContent(2,this.imageElement)):this.imageElement=a.document.createElement("img")},onOk:function(){this.imageEditMode?(this.imageElement=this.originalImageElement,delete this.originalImageElement):(this.imageElement=a.document.createElement("img"),this.imageElement.setAttribute("alt",""));this.linkEditMode||(this.linkElement=a.document.createElement("a"));this.commitContent(2,this.imageElement);this.commitContent(1,
this.linkElement);this.imageElement.getAttribute("style")||this.imageElement.removeAttribute("style");this.imageEditMode?!this.linkEditMode&&this.addLink?(a.insertElement(this.linkElement),this.imageElement.appendTo(this.linkElement)):this.linkEditMode&&!this.addLink&&(this.linkElement.remove(1),a.insertElement(this.imageElement)):this.addLink?this.linkEditMode?a.insertElement(this.imageElement):(a.insertElement(this.linkElement),this.linkElement.append(this.imageElement,!1)):a.insertElement(this.imageElement)},
onHide:function(){delete this.imageElement},contents:[{id:"info",label:"Info",accessKey:"I",elements:[{type:"vbox",padding:0,children:[{type:"hbox",widths:["290px","100px"],align:"right",children:[{id:"filename",type:"text",label:"Filename",onLoad:function(){this.getElement().setAttribute("disabled","disabled")},commit:function(a,b){var c=JSON.parse(n.decode(this.getElement().data("resp")));if(2==a){var f=this.getDialog().getContentElement("info","size"),c=e(c.url,f.getValue());b.setAttribute("src",
c);b.data("cke-saved-src",c);b.data("resp",this.getElement().data("resp"))}},setup:function(a,b){if(2==a){var c=JSON.parse(n.decode(b.data("resp")));d(this.getDialog(),c)}}},{type:"button",id:"browse",style:"display: inline-block; margin-top: 14px;",label:"Browse",onLoad:function(){var a=this.getDialog(),b=CKEDITOR.document.createElement("input");b.setAttribute("type","file");b.on("change",function(b){f(b.sender.$.files[0],a)});b.setAttribute("style","position: absolute; visibility: collapse");this.getElement().getParent().append(b);
this.on("click",function(){b.$.click()})}}]}]},{id:"caption",type:"text",label:"Caption",accessKey:"T","default":"",setup:function(a,b){2==a&&this.setValue(b.getAttribute("alt"))},commit:function(a,b){2==a?(this.getValue()||this.isChanged())&&b.setAttribute("alt",this.getValue()):1==a?b.setAttribute("title",this.getValue()):3==a&&b.removeAttribute("alt")}},{type:"hbox",widths:["110px","280px"],align:"left",children:[{type:"vbox",children:[{id:"size",type:"text",label:"Size"},{id:"lightbox",type:"checkbox",
label:"Lightbox",commit:function(a,b){if(this.getValue()){this.getDialog().addLink=!0;var c=JSON.parse(n.decode(this.getDialog().getContentElement("info","filename").getElement().data("resp")));1==a&&(b.setAttribute("class","lightbox"),b.setAttribute("href",e(c.url,Math.max(c.width,c.height))))}else this.getDialog().addLink=!1}},{id:"float",label:"Float",type:"select",items:[["None",""],["Left","left"],["Right","right"]],setup:function(a,b){if(2==a){var c=b.getStyle("float");if("none"==c||"inherit"==
c)c="";this.setValue(c)}},commit:function(a,b){if(2==a){var c=this.getValue();b.removeClass("float-left");b.removeClass("float-right");b.removeStyle("float");c&&(b.addClass("float-"+c),b.setStyle("float",c))}}}]},{type:"html",html:'\x3cdiv style\x3d"width: 100%; height: 200px; border: solid 1px #000; text-align: center;"\x3e\x3cimg src\x3d"" id\x3d"'+g+'" /\x3e\x3c/div\x3e'}]}]}]}}CKEDITOR.dialog.add("imgblob",function(a){return p(a,"imgblob")});var n={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\x3d",
encode:function(a){var e="",f,g,k,b,c,l,h=0;for(a=n._utf8_encode(a);h<a.length;)f=a.charCodeAt(h++),g=a.charCodeAt(h++),k=a.charCodeAt(h++),b=f>>2,f=(f&3)<<4|g>>4,c=(g&15)<<2|k>>6,l=k&63,isNaN(g)?c=l=64:isNaN(k)&&(l=64),e=e+this._keyStr.charAt(b)+this._keyStr.charAt(f)+this._keyStr.charAt(c)+this._keyStr.charAt(l);return e},decode:function(a){var e="",f,g,k,b,c,l=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<a.length;)f=this._keyStr.indexOf(a.charAt(l++)),g=this._keyStr.indexOf(a.charAt(l++)),b=this._keyStr.indexOf(a.charAt(l++)),
c=this._keyStr.indexOf(a.charAt(l++)),f=f<<2|g>>4,g=(g&15)<<4|b>>2,k=(b&3)<<6|c,e+=String.fromCharCode(f),64!=b&&(e+=String.fromCharCode(g)),64!=c&&(e+=String.fromCharCode(k));return n._utf8_decode(e)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var e="",f=0;f<a.length;f++){var g=a.charCodeAt(f);128>g?e+=String.fromCharCode(g):(127<g&&2048>g?e+=String.fromCharCode(g>>6|192):(e+=String.fromCharCode(g>>12|224),e+=String.fromCharCode(g>>6&63|128)),e+=String.fromCharCode(g&63|128))}return e},
_utf8_decode:function(a){for(var e="",f=0,g=c1=c2=0;f<a.length;)g=a.charCodeAt(f),128>g?(e+=String.fromCharCode(g),f++):191<g&&224>g?(c2=a.charCodeAt(f+1),e+=String.fromCharCode((g&31)<<6|c2&63),f+=2):(c2=a.charCodeAt(f+1),c3=a.charCodeAt(f+2),e+=String.fromCharCode((g&15)<<12|(c2&63)<<6|c3&63),f+=3);return e}}})();